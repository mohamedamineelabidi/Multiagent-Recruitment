name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort
          
      - name: Check formatting with black
        run: black --check --diff app/
        continue-on-error: true
        
      - name: Check import sorting with isort
        run: isort --check-only --diff app/
        continue-on-error: true
        
      - name: Lint with flake8
        run: flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics

  build:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Verify imports
        run: |
          python -c "from app.main import app; print('âœ… Application imports successfully')"
        env:
          DATABASE_URL: sqlite:///./test.db
          AZURE_OPENAI_API_KEY: test-key
          AZURE_OPENAI_API_BASE: https://test.openai.azure.com/
          AZURE_OPENAI_API_VERSION: 2024-12-01-preview
          AZURE_OPENAI_DEPLOYMENT_NAME: test-deployment

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker image
        run: docker build -t arya-api:test .
        
      - name: Verify Docker image
        run: docker images arya-api:test
